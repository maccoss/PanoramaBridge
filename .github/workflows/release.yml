name: Release Builder

# Manual release workflow - creates official releases
on:
  # Manual trigger with options only
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a new release'
        required: false
        default: false
        type: boolean
      release_tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: false
        default: ''
        type: string
      release_name:
        description: 'Release name'
        required: false
        default: ''
        type: string

# Required permissions for the GITHUB_TOKEN
permissions:
  contents: write  # Required to create releases and download artifacts
  actions: read    # Required to read workflow artifacts

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        architecture: x64
        cache: 'pip'
        
    - name: Verify Python Architecture
      run: |
        python -c "import platform; print(f'Python platform: {platform.machine()} - {platform.architecture()[0]}')"
        python -c "import sys; print(f'Python executable: {sys.executable}')"
        Write-Host "Building for: x64 (Intel/AMD 64-bit)" -ForegroundColor Cyan
      shell: powershell
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        pip install pytest
        
    - name: Verify PyQt6 Installation
      run: |
        python -c "import PyQt6.QtCore; print(f'PyQt6 Version: {PyQt6.QtCore.PYQT_VERSION_STR}')"
      shell: powershell
        
    - name: Run tests
      run: |
        python -m pytest tests/ -v --tb=short
      continue-on-error: true  # Don't fail build if tests fail
      
    - name: Build Windows executable
      run: |
        Write-Host "Building PanoramaBridge executable for x64..." -ForegroundColor Cyan
        pyinstaller build_scripts/PanoramaBridge.spec
        
        if (Test-Path "dist/PanoramaBridge.exe") {
          Write-Host "Build completed successfully!" -ForegroundColor Green
          
          # Get file info
          $fileInfo = Get-Item "dist/PanoramaBridge.exe"
          $sizeInMB = [math]::Round($fileInfo.Length / 1MB, 2)
          $hash = (Get-FileHash "dist/PanoramaBridge.exe" -Algorithm SHA256).Hash
          
          Write-Host "File: PanoramaBridge.exe" -ForegroundColor Yellow
          Write-Host "Size: $($fileInfo.Length) bytes ($sizeInMB MB)" -ForegroundColor Yellow
          Write-Host "SHA256: $hash" -ForegroundColor Yellow
          Write-Host "Architecture: x64 (Intel/AMD 64-bit)" -ForegroundColor Yellow
          
          # Try to get executable architecture info
          try {
            $archInfo = & dumpbin /headers "dist/PanoramaBridge.exe" 2>$null | Select-String "machine"
            if ($archInfo) {
              Write-Host "Executable target: $archInfo" -ForegroundColor Yellow
            }
          } catch {
            Write-Host "Could not verify executable architecture (dumpbin not available)" -ForegroundColor Yellow
          }
          
          # Save info for later steps
          echo "EXECUTABLE_SIZE=$($fileInfo.Length)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "EXECUTABLE_SIZE_MB=$sizeInMB" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "EXECUTABLE_HASH=$hash" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        } else {
          Write-Host "Build failed - executable not found!" -ForegroundColor Red
          Get-ChildItem -Recurse dist/ -ErrorAction SilentlyContinue
          exit 1
        }
      shell: powershell
      
    - name: Create build info
      run: |
        $buildInfo = @"
        PanoramaBridge Windows Build (x64)
        ===================================
        
        Architecture: x64 (Intel/AMD 64-bit)
        Build Date: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')
        Git Commit: ${{ github.sha }}
        Git Ref: ${{ github.ref }}
        
        Executable Info:
        - File: PanoramaBridge.exe
        - Size: ${{ env.EXECUTABLE_SIZE }} bytes (${{ env.EXECUTABLE_SIZE_MB }} MB)
        - SHA256: ${{ env.EXECUTABLE_HASH }}
        
        System Info:
        - OS: Windows Latest (GitHub Actions)
        - Runner: windows-latest
        - Python: 3.12 (x64)
        - PyInstaller: $(pip show pyinstaller | Select-String "Version:" | ForEach-Object { $_.ToString().Split(":")[1].Trim() })
        
        Installation:
        1. Download PanoramaBridge.exe
        2. Run the executable (Windows may show security warning for unsigned files)
        3. Configure your WebDAV settings
        
        Compatibility:
        - Intel/AMD 64-bit processors
        - Windows 10/11
        "@
        
        $buildInfo | Out-File -FilePath "dist/BUILD_INFO_x64.txt" -Encoding UTF8
        Write-Host "Build info created"
      shell: powershell
      
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: PanoramaBridge-Windows-x64-Build-${{ github.run_number }}
        path: |
          dist/PanoramaBridge.exe
          dist/BUILD_INFO_x64.txt
        retention-days: 90
        
  # Separate job to create the release after all builds complete
  create-release:
    needs: build-and-release
    runs-on: ubuntu-latest
    if: github.event.inputs.create_release == 'true'
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts
        
    - name: Prepare release assets
      run: |
        # Create release directory
        mkdir -p release-assets
        
        # Find and copy all executables and build info files
        find ./artifacts -name "*.exe" -exec cp {} ./release-assets/ \;
        find ./artifacts -name "BUILD_INFO_*.txt" -exec cp {} ./release-assets/ \;
        
        # List what we found
        echo "Release assets prepared:"
        ls -la ./release-assets/
        
        # Get file sizes and hashes for release notes
        cd ./release-assets
        echo "## Build Information" > ../build-summary.md
        echo "" >> ../build-summary.md
        
        for exe in *.exe; do
          if [ -f "$exe" ]; then
            size=$(stat -f%z "$exe" 2>/dev/null || stat -c%s "$exe")
            size_mb=$(echo "scale=2; $size / 1048576" | bc -l 2>/dev/null || echo "$(($size / 1048576))")
            hash=$(shasum -a 256 "$exe" | cut -d' ' -f1)
            
            echo "### $exe" >> ../build-summary.md
            echo "- **Size:** $size bytes (${size_mb} MB)" >> ../build-summary.md
            echo "- **SHA256:** \`$hash\`" >> ../build-summary.md
            echo "" >> ../build-summary.md
          fi
        done
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.event.inputs.release_tag }}
        name: ${{ github.event.inputs.release_name }}
        draft: false
        prerelease: false
        generate_release_notes: true
        files: |
          ./release-assets/*
        body: |
          ## PanoramaBridge ${{ github.event.inputs.release_tag }}
          
          **Windows Desktop Application**
          
          ### Download
          - **PanoramaBridge.exe** - For Intel/AMD Windows computers
          - Compatible with Windows 10/11 systems
          
          ### Installation Options

          **Option 1: Windows Standalone Executable (Recommended for most users)**
          1. Download `PanoramaBridge.exe` from the assets below
          2. Run the executable (Windows may show a security warning for unsigned applications - click "More info" then "Run anyway")
          3. Configure your WebDAV server settings
          4. Start monitoring your files!

          **Option 2: Install from PyPI (For Python developers)**

          PanoramaBridge is now available on PyPI! Install it using pip:

          ```bash
          pip install panoramabridge
          ```

          Then run it with:
          ```bash
          panoramabridge
          ```

          Or import it in your Python code:
          ```python
          from panoramabridge import PanoramaBridgeApp
          ```

          **Requirements for PyPI installation:**
          - Python 3.12 or higher
          - Windows, macOS, or Linux
          - Dependencies automatically installed: PyQt6, requests, watchdog, lxml
          
          ### What's New in v0.1.9

          **Major Improvements:**
          - **Enhanced Upload Reliability**: Added comprehensive retry logic for transient server errors (HTTP 502/503/504) with exponential backoff
          - **Better Error Reporting**: All HTTP errors now include status codes, reason phrases, and server response details
          - **Improved Progress Tracking**: Real-time progress indicators now work accurately for large files using streaming uploads
          - **Smarter Verification**: Added retry logic for file verification with automatic delays to handle server-side indexing
          - **Timeout Protection**: All HTTP operations now have configurable timeouts to prevent infinite hangs

          **Bug Fixes:**
          - Fixed TypeError in verification message checking that was causing uploads to fail
          - Fixed progress bar jumping from 0% to 100% for large files by implementing true streaming uploads
          - Fixed silent upload failures by ensuring all errors are properly reported to users
          - Resolved 404 errors during verification by adding retry delays

          **Technical Enhancements:**
          - Streaming file uploads with 1MB chunks for better memory efficiency
          - Content-Length headers for proper HTTP streaming support
          - Comprehensive test suite with 22 tests covering all error scenarios
          - Code quality improvements with ruff linter compliance
                   
          ### System Requirements
          - **Windows 11** (recommended) or **Windows 10**
          - **Intel/AMD 64-bit processor**
          - No additional installations required - this is a standalone executable
          
          ### Build Details
          See the `BUILD_INFO_x64.txt` file for detailed build information including checksums.
          
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}



